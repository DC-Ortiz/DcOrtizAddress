<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‹ DC Ortiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { max-width: 480px; margin: 20px auto; padding: 15px; }
    .suggestions { border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; display: none; position: absolute; width: 100%; background: white; z-index: 9999; }
    .suggestions div { padding: 8px; cursor: pointer; }
    .suggestions div:hover { background: #f0f0f0; }
    .position-relative { position: relative; }
    #alertaModificacion, #spinner, #resultadoConsulta, #detalleResultados { display: none; }
    #resultadoConsulta, #detalleResultados { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h4 class="text-center mb-3">ğŸ“‹ DC Ortiz</h4>

  <div id="alertaModificacion" class="alert alert-danger" role="alert">
    âš ï¸ Este trabajo ya fue realizado por <span id="nombreAlerta"></span>.
  </div>

  <!-- DirecciÃ³n -->
  <div class="mb-2 position-relative">
    <label for="buscar">DirecciÃ³n:</label>
    <input class="form-control" id="buscar" placeholder="Empieza a escribir..." autocomplete="off" required>
    <div id="sugerencias" class="suggestions"></div>
  </div>

  <!-- Botones -->
  <div class="d-flex gap-2 mb-3">
    <button id="copiar" class="btn btn-secondary flex-fill">ğŸ“‹ Copiar</button>
    <button id="limpiar" class="btn btn-outline-secondary flex-fill">ğŸ§¹ Limpiar</button>
    <button id="recargar" class="btn btn-outline-primary flex-fill" hidden>ğŸ”„ Recargar</button>
  </div>

  <!-- Formulario -->
  <form id="formulario" autocomplete="off">
    <input type="hidden" name="Address" id="direccionSeleccionada" />
    <label for="nombre">Nombre:</label>
    <input type="text" class="form-control" id="nombre" name="Name" required>
    <label for="fecha">Fecha:</label>
    <input type="date" class="form-control" id="fecha" name="Date" required>
    <button type="submit" class="btn btn-success w-100 mt-3" id="btnActualizar">âœ… Actualizar</button>
  </form>

  <!-- Spinner -->
  <div id="spinner" class="text-center mt-3">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargandoâ€¦</span></div>
    <div>Cargandoâ€¦</div>
  </div>

  <hr>
  <!-- Consulta -->
  <h5>ğŸ” Consultar trabajos hechos</h5>
  <button class="btn btn-info w-100 mb-2" id="btnConsultar">ğŸ” Buscar por fecha</button>

  <div id="resultadoConsulta" class="border rounded p-2 bg-light">
    <div class="fw-bold mb-2">Trabajos realizados: <span id="contadorTrabajos"></span></div>
    <button class="btn btn-outline-secondary btn-sm w-100" onclick="mostrarDetalle()">Ver detalle completo</button>
  </div>

  <div id="detalleResultados" class="border rounded p-2 mt-3 bg-white">
    <h6>ğŸ“„ Detalle completo</h6>
    <table class="table table-bordered table-sm">
      <thead><tr><th>Nombre</th><th>DirecciÃ³n</th><th>Fecha</th></tr></thead>
      <tbody id="tablaDetalle"></tbody>
    </table>
  </div>

<script>
/* ---------- FECHAS ---------- */

// Convierte lo que venga de la hoja a YYYY-MM-DD
function fechaSheetAISO(txt){
  if(!txt) return "";
  txt = txt.trim();
  // 1) Ya ISO
  if(/^\d{4}-\d{2}-\d{2}$/.test(txt)) return txt;

  // 2) Con barras  (MM/DD/YYYY o DD/MM/YYYY)
  if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(txt)){
    const [p1,p2,p3]=txt.split("/");
    let mm,dd;
    // Si la primera parte >12, asumimos DD/MM
    if(+p1>12){ dd=p1.padStart(2,"0"); mm=p2.padStart(2,"0"); }
    else      { mm=p1.padStart(2,"0"); dd=p2.padStart(2,"0"); }
    const yyyy = p3.length===2 ? "20"+p3 : p3;
    return `${yyyy}-${mm}-${dd}`;
  }

  // 3) Con nombre de mes (01 Aug, 1 Aug 25, etc.)
  const m = txt.match(/^(\d{1,2})\s+([A-Za-z]{3,})\.?,?\s*(\d{2,4})?$/);
  if(m){
    const dd = m[1].padStart(2,"0");
    const mmm = m[2].substring(0,3).toLowerCase();
    const map = {jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",
                 aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"};
    const mm = map[mmm] || "01";
    const yyyy = m[3] ? (m[3].length===2 ? "20"+m[3] : m[3]) : new Date().getFullYear();
    return `${yyyy}-${mm}-${dd}`;
  }
  return "";
}

// Fecha actual en BogotÃ¡ (UTC-5)  YYYY-MM-DD
function hoyBogota(){
  const local = new Date();
  const diffMs = (-5*60 - local.getTimezoneOffset())*60000;
  return new Date(local.getTime()+diffMs).toISOString().split("T")[0];
}

/* ---------- CONSTANTES ---------- */
const SHEET_ID   = "1dN277eFZktV3XX4VfiG-1-kzw66RAIoISRrIAbT58S4";
const SHEET_NAME = "Sheet1";
const JSON_URL   = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;
const POST_URL   = "https://script.google.com/macros/s/AKfycbz8U1L4L4lp5eFKFie9jf1Ji2dlqNUzxiz60ZOqQoHijr-L4cdLugd3IV4FFwvKVf0E/exec";

/* ---------- DOM ---------- */
const buscar     = document.getElementById("buscar");
const sugerencias= document.getElementById("sugerencias");
const hiddenDir  = document.getElementById("direccionSeleccionada");
const nombre     = document.getElementById("nombre");
const fecha      = document.getElementById("fecha");
const alerta     = document.getElementById("alertaModificacion");
const nombreAlerta=document.getElementById("nombreAlerta");
const btnAct     = document.getElementById("btnActualizar");
const spinner    = document.getElementById("spinner");
let direcciones=[], registros=[];

/* ---------- FUNCIONES ---------- */
async function cargarHoja(){
  try{
    const r=await fetch(JSON_URL);
    registros=await r.json();
    direcciones=[...new Set(registros.map(x=>x.Address).filter(Boolean))].sort();
  }catch{alert("âŒ No se pudo cargar la hoja.");}
}

function resetForm(){
  alerta.style.display="none";
  nombre.value=localStorage.getItem("miNombreGuardado")||"";
  fecha.value=hoyBogota();
  nombre.disabled=fecha.disabled=btnAct.disabled=false;
}

/* ---------- AUTOCOMPLETE ---------- */
buscar.addEventListener("input",()=>{
  const q=buscar.value.toLowerCase();
  sugerencias.innerHTML="";
  resetForm();
  if(!q) return sugerencias.style.display="none";
  direcciones.filter(d=>d.toLowerCase().includes(q)).forEach(d=>{
    const div=document.createElement("div"); div.textContent=d;
    div.onclick=()=>seleccionarDireccion(d);
    sugerencias.appendChild(div);
  });
  sugerencias.style.display=sugerencias.children.length?"block":"none";
});

function seleccionarDireccion(dir){
  buscar.value=dir; hiddenDir.value=dir; sugerencias.style.display="none";
  const reg=registros.find(r=>r.Address===dir);
  if(!reg) return;
  nombre.value  = reg.Name || localStorage.getItem("miNombreGuardado") || "";
  fecha.value   = reg.Date ? fechaSheetAISO(reg.Date) : hoyBogota();
  const completado = reg.Name && reg.Date;
  alerta.style.display = completado ? "block":"none";
  nombreAlerta.textContent = reg.Name||"";
  nombre.disabled = fecha.disabled = btnAct.disabled = completado;
}

/* ---------- BOTONES RÃPIDOS ---------- */
document.getElementById("copiar").onclick = ()=> {
  if(!buscar.value) return alert("Escribe una direcciÃ³n");
  navigator.clipboard.writeText(buscar.value).then(()=>alert("DirecciÃ³n copiada âœ…"));
};
document.getElementById("limpiar").onclick = ()=>{buscar.value=""; hiddenDir.value=""; resetForm(); buscar.focus();};
document.getElementById("recargar").onclick = cargarHoja;

/* ---------- NORMALIZAR NOMBRE ---------- */
nombre.addEventListener("input",()=>{
  let v=nombre.value.trimStart();
  if(v) v=v[0].toUpperCase()+v.slice(1);
  nombre.value=v.replace(/\s+$/,"");
});
nombre.addEventListener("blur",()=>{const n=nombre.value.trim(); if(n) localStorage.setItem("miNombreGuardado",n);});

/* ---------- SUBMIT ---------- */
document.getElementById("formulario").addEventListener("submit",async e=>{
  e.preventDefault();
  const dir=buscar.value.trim(), nom=nombre.value.trim(), fec=fecha.value;
  if(!dir||!nom||!fec) return alert("âš ï¸ Completa todos los campos.");

  try{
    spinner.style.display="block";
    registros = await (await fetch(JSON_URL)).json();
    if(registros.some(r=>r.Address===dir && r.Name && r.Date))
      return alert("âŒ Esta direcciÃ³n ya fue registrada.");

    const fd=new FormData(); fd.append("Address",dir); fd.append("Name",nom); fd.append("Date",fec);
    const res=await fetch(POST_URL,{method:"POST",body:fd});
    if(!res.ok) throw new Error("Error al guardar");
    alert("âœ… InformaciÃ³n guardada.");
    await cargarHoja(); document.getElementById("limpiar").click();
  }catch(err){alert("âŒ "+err.message);}finally{spinner.style.display="none";}
});

/* ---------- CONSULTA POR FECHA ---------- */
document.getElementById("btnConsultar").addEventListener("click",async()=>{
  const nom = nombre.value.trim().toLowerCase();
  const dia = fecha.value.trim();
  if(!dia) return alert("Selecciona una fecha vÃ¡lida");

  const cont = document.getElementById("resultadoConsulta");
  const tabla= document.getElementById("tablaDetalle");
  const contador=document.getElementById("contadorTrabajos");
  tabla.innerHTML="";

  try{registros=await (await fetch(JSON_URL)).json();}catch{return alert("âŒ Error al actualizar datos.");}

  const res = registros.filter(r=>{
    return (r.Name||"").toLowerCase().trim()===nom &&
           fechaSheetAISO(r.Date)===dia;
  });

  if(res.length){
    res.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.Name}</td><td>${r.Address}</td><td>${fechaSheetAISO(r.Date)}</td>`;
      tabla.appendChild(tr);
    });
    contador.textContent=res.length;
    cont.style.display="block";
  }else{cont.style.display="none"; alert("No hay registros para esa fecha.");}
});

/* ---------- Mostrar detalle ---------- */
function mostrarDetalle(){document.getElementById("detalleResultados").style.display="block";}

/* ---------- INICIAL ---------- */
document.addEventListener("DOMContentLoaded",async()=>{
  const n=localStorage.getItem("miNombreGuardado"); if(n) nombre.value=n;
  fecha.value=hoyBogota();
  await cargarHoja();
});
</script>
</body>
</html>
